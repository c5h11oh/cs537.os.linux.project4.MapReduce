# ostep-projects: concurrency-mapreduce implementation
## Overview
This is an implementation of [OSTEP project](https://github.com/remzi-arpacidusseau/ostep-projects): [Concurrency-MapReduce (in a single machine)](https://github.com/remzi-arpacidusseau/ostep-projects/tree/master/concurrency-mapreduce). The original MapReduce (`"MR"` below) paper can be found [here](https://static.googleusercontent.com/media/research.google.com/en//archive/mapreduce-osdi04.pdf).

## What's inside
There are three files forming up the program: `mapreduce.h`, `mapreduce.c`, and `main.c`. The remaining files include ones that automate the compile, test, and clean processes (`Makefile` and `runtest.sh`) and those serve as testcases (lying inside `testcases` and `testcases_unused` directories). The results generated by prompt `make test`, including raw and sorted output (`out-*.txt`) as well as execution duration report of various number of mapper/reducer (`stat-*.txt`) are under the `testresult` directory.

### mapreduce.h
`mapreduce.h` defines the signature of MR's key functions, including the user defined `Getter`, `Mapper`, `Partitioner`, `Reducer`, as well as the emit (`MR_Emit`) and run (`MR_Run`, the entry point) functions that will be used during the process.

### mapreduce.c
`mapreduce.c` is the heart of this MR implementation. It consists of main functions such as `MR_Run`, `MR_Mapper`, and `MR_Reducer`; internal functions `MR_Emit`, `MR_sort`, `MR_DefaultGetter`; some helper functions `compareEntry`, `MR_Partition_Expand`; default hasher `MR_DefaultHashPartition`. Data structures used during the process are also defined here.
#### MR_Run
- The `MR_Run` function is the entry function whichever the program that needs MR calls. 
- It goes through the following operations:
  1. Initialization
  2. Create mappers to work by calling `MR_Mapper`
  3. Build "input buffer" containing works to be fetched by the mappers
  4. Join the mappers. After that, tidy up the work done by the mapper (sort the keys `Partition`s). Done by calling `MR_sort`
  5. Create reducers to work by calling `MR_Reducer`
  6. Join the reducers. Clean up
- Inside `MR_Run`, there are also `fprintf` that output the duration information to `stderr`.

#### MR_Mapper
- Always fetching a partition of work from "input buffer" and run the user defined `mapper` to do the job.
- Stop when there is no more input given and the "input buffer" is clear.

#### MR_sort
- After mapper mapped the key-value pair to appropriate "partitions" (buckets), `MR_sort` sorts all elements in each partition in order to make the reducer's life easier.

#### MR_Reducer
- One reducer is responsible for dealing with one partition. It has to retrieve the 

#### MR_Emit
- In the user defined `mapper` function, one calls `MR_Emit` to emit (send) the key-value pair to the appropriate partition (bucket). `MR_DefaultHashPartition` determines which bucket is appropriate for a certain key.

#### MR_DefaultGetter
- The counterpart of `MR_Emit`. In user defined `reducer` function, if one wants to deal with the next (sorted) key-value pair in the partition, it calls `MR_DefaultGetter`.

#### compareEntry
- A helper function used by `MR_sort` that compare the keys.
- Uses `strcmp`.

#### MR_Partition_Expand
- The default `Partition` has the size `INITIAL_PARTITION_CAPACITY`. If there are more key-value pairs to be put in the partition, calling `MR_Partition_Expand` doubles the partition size. 

### main.c
- `main.c` is the main function that drives the MR functionalities. 
- To test the performance, `main.c` currently asks the user what's the desired maximum number of mappers/reducers. Then, the program will call `MR_Run` multiple times, each time with a different combination of numbers of mappers and reducers (differing by a factor of 2 each time).
- As an MR application example, `main.c` contains a "wordcount" application, implemented as `Map` and `Reduce` functions, which are passed into the `MR_Run` call.
- For brevity, `MR_Run` is wrapped by the function `MR_Run_Wrapper`. The wrapper redirects the function output (`stdout`) to `testresult/out-XXX-YYY.txt`. Performance data (duration data), given by `MR_Run` through `stderr`, is redirected to `testresult/stat-A-map-B-red.txt`.

## How to use
In the terminal, change to the projects directory and type prompts...
1. Remove compiled executables and previous test results
    ```bash
    > make clean
    ```
2. Build
    ```bash
    > make
    ```
3. Run test
    ```bash
    > make test
    ```
You can see the executed result in `testresult/`. The file `out-XXX-YYY.txt` stores the execution of `XXX` mappers and `YYY` reducers. The performance data can be found in `stat-A-map-B-red.txt` files, where `A`, `B` represents the number of mappers and reducers respectively. `A`/`B`'s value can be `1`, `M`, or `x`, meaning there is/are 1 / maximum workers (either mapper or reducer), or the number is the variable. `diff` is used to compare between all sorted outputs generated by different execution rounds (have different number of mappers/reducers). You can see the result in `testresult/sorted/diff.txt`. All output files should be identical.